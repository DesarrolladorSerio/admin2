services:

#Bases de datos : 
#------------------------------------------#

  # ==========================
  # üóÑÔ∏è Autenticacion
  # ==========================
  auth-db:
    image: postgres:16.4
    container_name: auth_db_primary
    environment:
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD}
      POSTGRES_DB: ${AUTH_DB_NAME}
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replica_pass
    ports:
      - "${AUTH_DB_PORT}:5432"
    volumes:
      - auth_primary_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/auth-init:/docker-entrypoint-initdb.d
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_DB_USER} -d ${AUTH_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    # Replicaci√≥n: verificar en el primario ->
    #   docker compose exec auth-db psql -U ${AUTH_DB_USER} -d ${AUTH_DB_NAME} -c "SELECT client_addr,state,sync_state FROM pg_stat_replication;"
    # Promover r√©plica (failover manual):
    #   docker compose exec auth-db-replica pg_ctl -D /var/lib/postgresql/data promote
    networks:
      database_net:

  auth-db-replica:
    image: postgres:16.4
    container_name: auth_db_replica
    depends_on:
      auth-db:
        condition: service_healthy
    environment:
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD}
      POSTGRES_DB: ${AUTH_DB_NAME}
      PRIMARY_HOST: auth-db
      PRIMARY_PORT: 5432
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replica_pass
    # Replica: s√≥lo realiza pg_basebackup si a√∫n no existe standby.signal
    entrypoint:
      - bash
      - -c
      - |
        set -e
        # Idempotente: si no existe PG_VERSION, clonamos; si existe iniciamos directamente.
        if [ ! -s "/var/lib/postgresql/data/PG_VERSION" ]; then
          until pg_isready -h auth-db -p 5432; do sleep 2; done
          rm -rf "/var/lib/postgresql/data"/*
          PGPASSWORD='replica_pass' pg_basebackup -h auth-db -D "/var/lib/postgresql/data" -U replicator -Fp -Xs -P -R
          chmod 700 "/var/lib/postgresql/data"
        fi
        exec docker-entrypoint.sh postgres
    volumes:
      - auth_replica_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    networks:
      - database_net

  # ==========================
  # üóÑÔ∏è Base de datos de Reservas
  # ==========================
  reservations-db-primary:
    image: postgres:16.4
    container_name: reservations_db_primary
    environment:
      POSTGRES_USER: ${RESERVATIONS_DB_USER}
      POSTGRES_PASSWORD: ${RESERVATIONS_DB_PASSWORD}
      POSTGRES_DB: ${RESERVATIONS_DB_NAME}
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replica_pass
    ports:
      - "${RESERVATIONS_DB_PORT}:5432"
    volumes:
      - reservations_primary_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/reservations-init:/docker-entrypoint-initdb.d
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${RESERVATIONS_DB_USER} -d ${RESERVATIONS_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    # Replicaci√≥n: verificar ->
    #   docker compose exec reservations-db-primary psql -U ${RESERVATIONS_DB_USER} -d ${RESERVATIONS_DB_NAME} -c "SELECT client_addr,state,sync_state FROM pg_stat_replication;"
    # Promover r√©plica:
    #   docker compose exec reservations-db-replica pg_ctl -D /var/lib/postgresql/data promote
    networks:
      - database_net

  reservations-db-replica:
    image: postgres:16.4
    container_name: reservations_db_replica
    depends_on:
      reservations-db-primary:
        condition: service_healthy
    environment:
      POSTGRES_USER: ${RESERVATIONS_DB_USER}
      POSTGRES_PASSWORD: ${RESERVATIONS_DB_PASSWORD}
      POSTGRES_DB: ${RESERVATIONS_DB_NAME}
      PRIMARY_HOST: reservations-db-primary
      PRIMARY_PORT: 5432
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replica_pass
    # Replica idempotente
    entrypoint:
      - bash
      - -c
      - |
        set -e
        if [ ! -s "/var/lib/postgresql/data/PG_VERSION" ]; then
          until pg_isready -h reservations-db-primary -p 5432; do sleep 2; done
          rm -rf "/var/lib/postgresql/data"/*
          PGPASSWORD='replica_pass' pg_basebackup -h reservations-db-primary -D "/var/lib/postgresql/data" -U replicator -Fp -Xs -P -R
          chmod 700 "/var/lib/postgresql/data"
        fi
        exec docker-entrypoint.sh postgres
    volumes:
      - reservations_replica_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 64M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 5432"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped
    networks:
      - database_net

  # ==========================
  # üóÑÔ∏è Base de datos de Documentos (SIN R√âPLICA)
  # ==========================
  documents-db:
    image: postgres:16.4
    container_name: documents_db
    environment:
      POSTGRES_USER: ${DOCUMENTS_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DOCUMENTS_DB_PASSWORD:-password}
      POSTGRES_DB: ${DOCUMENTS_DB_NAME:-documents}
    ports:
      - "${DOCUMENTS_DB_PORT:-5434}:5432"
    volumes:
      - documents_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/documents-init:/docker-entrypoint-initdb.d
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DOCUMENTS_DB_USER:-postgres} -d ${DOCUMENTS_DB_NAME:-documents}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    networks:
      database_net:

  # ==========================
  # üóÑÔ∏è Base de datos de ChatBot IA
  # ==========================
  # üóÑÔ∏è Base de datos de ChatBot IA (SIN R√âPLICA)
  # ==========================
  chatbot-db:
    image: postgres:16.4
    container_name: chatbot_db
    environment:
      POSTGRES_USER: ${CHATBOT_DB_USER:-admin}
      POSTGRES_PASSWORD: ${CHATBOT_DB_PASSWORD:-admin}
      POSTGRES_DB: ${CHATBOT_DB_NAME:-chatbot_db}
    ports:
      - "${CHATBOT_DB_PORT:-5436}:5432"
    volumes:
      - chatbot_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/chatbot-init:/docker-entrypoint-initdb.d
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CHATBOT_DB_USER:-admin} -d ${CHATBOT_DB_NAME:-chatbot_db}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    networks:
      database_net:

  # ==========================
  # üì¶ MinIO - Almacenamiento de archivos
  # ==========================
  minio:
    image: minio/minio:RELEASE.2024-07-26T20-48-21Z
    container_name: minio_storage
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"  
    volumes:
      - minio_data:/data
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      storage_net:

  # ==========================
  # üî¥ Redis - Sistema de Cola
  # ==========================
  redis:
    image: redis:7-alpine
    container_name: redis_queue
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 64M
    restart: unless-stopped
    networks:
      backend_net:

  # ==========================
  # ‚öôÔ∏è Servicio de Autenticaci√≥n (FastAPI)
  # Nota: duplicado en `auth-service-1` y `auth-service-2` para alta disponibilidad
  # (el servicio original fue sustituido por dos instancias para el cl√∫ster HA)

  # --------------------------
  # ‚öôÔ∏è Servicio de Autenticaci√≥n - r√©plica activa (instancias duplicadas)
  # --------------------------
  auth-service-1:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth_service_1
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${AUTH_DB_USER}:${AUTH_DB_PASSWORD}@auth-db:5432/${AUTH_DB_NAME}"
      PORT: 8000
    # Puerto NO expuesto al host - solo accesible via nginx
    expose:
      - "8000"
    depends_on:
      auth-db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net

  auth-service-2:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: auth_service_2
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${AUTH_DB_USER}:${AUTH_DB_PASSWORD}@auth-db:5432/${AUTH_DB_NAME}"
      PORT: 8000
    # no host port mapping for second replica
    depends_on:
      auth-db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net

  # ==========================
  # ‚öôÔ∏è Servicio de Reservas (FastAPI)
  # ==========================
  reservations-service-1:
    build:
      context: ./services/reservations-service
      dockerfile: Dockerfile
    container_name: reservations_service_1
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${RESERVATIONS_DB_USER}:${RESERVATIONS_DB_PASSWORD}@reservations-db-primary:5432/${RESERVATIONS_DB_NAME}"
      PORT: 8002
    # Puerto NO expuesto al host - solo accesible via nginx
    expose:
      - "8002"
    depends_on:
      reservations-db-primary:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net

  reservations-service-2:
    build:
      context: ./services/reservations-service
      dockerfile: Dockerfile
    container_name: reservations_service_2
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${RESERVATIONS_DB_USER}:${RESERVATIONS_DB_PASSWORD}@reservations-db-primary:5432/${RESERVATIONS_DB_NAME}"
      PORT: 8002
    # no host port mapping for second replica
    depends_on:
      reservations-db-primary:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net

  # ==========================
  # ‚öôÔ∏è Servicio de Documentos (FastAPI)
  # ==========================
  documents-service:
    build:
      context: ./services/documents-service
      dockerfile: Dockerfile
    container_name: documents_service
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${DOCUMENTS_DB_USER:-postgres}:${DOCUMENTS_DB_PASSWORD:-password}@documents-db:5432/${DOCUMENTS_DB_NAME:-documents}"
      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_SECURE: "false"
      MINIO_BUCKET: "documents"
      AUTH_SERVICE_URL: "http://auth-service-1:8000"
      SECRET_KEY: "un-secreto-muy-fuerte-y-largo"
      ALGORITHM: "HS256"
    # Puerto NO expuesto al host - solo accesible via nginx
    expose:
      - "8003"
    depends_on:
      documents-db:
        condition: service_healthy
      minio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net
      - storage_net

  # ==========================
  # ‚öôÔ∏è Servicio de Notificaciones (FastAPI + Celery)
  # ==========================
  notifications-service:
    build:
      context: ./services/notificacion-service
      dockerfile: Dockerfile
    container_name: notifications_service
    env_file:
      - .env
    environment:
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@sistema.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Sistema de Reservas}
      SMTP_TLS: ${SMTP_TLS:-true}
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      CELERY_BROKER_URL: "redis://redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://redis:6379/0"
      AUTH_SERVICE_URL: "http://auth-service-1:8000"
      RESERVATIONS_SERVICE_URL: "http://reservations-service-1:8002"
      DOCUMENTS_SERVICE_URL: "http://documents-service:8003"
      SECRET_KEY: "un-secreto-muy-fuerte-y-largo"
      ALGORITHM: "HS256"
    # Puerto NO expuesto al host - solo accesible via nginx
    expose:
      - "8004"
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      backend_net:

  # ==========================
  # ‚öôÔ∏è Celery Worker (Procesamiento de Cola)
  # ==========================
  celery-worker:
    build:
      context: ./services/notificacion-service
      dockerfile: Dockerfile
    container_name: celery_worker
    command: celery -A celery_config worker --loglevel=info --concurrency=2
    env_file:
      - .env
    environment:
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@sistema.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Sistema de Reservas}
      SMTP_TLS: ${SMTP_TLS:-true}
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      CELERY_BROKER_URL: "redis://redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://redis:6379/0"
    depends_on:
      redis:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "celery", "-A", "celery_config", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      backend_net:

  # ==========================
  # ü§ñ Servicio de ChatBot IA (INSTANCIA √öNICA)
  # ==========================
  chatbot-service:
    build:
      context: ./services/ai-service
      dockerfile: Dockerfile
    container_name: chatbot_service
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${CHATBOT_DB_USER:-admin}:${CHATBOT_DB_PASSWORD:-admin}@chatbot-db:5432/${CHATBOT_DB_NAME:-chatbot_db}"
      OLLAMA_BASE_URL: "http://ollama:11434"
      OLLAMA_MODEL: ${OLLAMA_MODEL:-llama2}
      OLLAMA_TIMEOUT: ${OLLAMA_TIMEOUT:-60}
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_DB: "1"
      AUTH_SERVICE_URL: "http://auth-service-1:8000"
      RESERVATIONS_SERVICE_URL: "http://reservations-service-1:8002"
      DOCUMENTS_SERVICE_URL: "http://documents-service:8003"
      SECRET_KEY: "un-secreto-muy-fuerte-y-largo"
      ALGORITHM: "HS256"
      PORT: 8005
    # Puerto NO expuesto al host - solo accesible via nginx
    expose:
      - "8005"
    depends_on:
      chatbot-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      ollama:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net

  # ==========================
  # üß† Ollama - LLM Local (100% GRATUITO)
  # ==========================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama_service
    ports:
      - "11434:11434"
    volumes:
      - ollama_models:/root/.ollama
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
    restart: unless-stopped
    networks:
      - backend_net
    healthcheck:
      test: ["CMD", "/bin/ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 600s
    # Comando para descargar modelo al inicio (si no existe)
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        /bin/ollama serve &
        OLLAMA_PID=$$!
        echo "‚è≥ Esperando que Ollama inicie..."
        sleep 10
        echo "üì• Descargando modelo llama2 (esto puede tardar en el primer inicio)..."
        /bin/ollama pull llama2 || echo "‚ö†Ô∏è  Advertencia: No se pudo descargar el modelo autom√°ticamente. Ejecuta: docker exec ollama_service ollama pull llama2"
        echo "‚úÖ Ollama listo con modelo llama2"
        wait $$OLLAMA_PID

  # ==========================
  # üìÇ Servicio de Datos Municipalidad (FastAPI)
  # ==========================
  datos-municipalidad-service:
    build:
      context: ./services/datos-municipalidad-service
      dockerfile: dockerfile
    container_name: datos_municipalidad_service
    env_file:
      - .env
    environment:
      DATABASE_URL: "postgresql+psycopg://${DOCUMENTS_DB_USER:-postgres}:${DOCUMENTS_DB_PASSWORD:-password}@documents-db:5432/${DOCUMENTS_DB_NAME:-documents}"
      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_SECURE: "false"
      MINIO_BUCKET: "municipalidad-docs"
      AUTH_SERVICE_URL: "http://auth-service-1:8000"
      SECRET_KEY: "un-secreto-muy-fuerte-y-largo"
      ALGORITHM: "HS256"
      PORT: 8006
    # Puerto NO expuesto al host - solo accesible via nginx
    expose:
      - "8006"
    depends_on:
      documents-db:
        condition: service_healthy
      minio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8006/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - backend_net
      - database_net
      - storage_net

  # ==========================
  # üíª Frontend (Nginx)
  # ==========================
  frontend:
    build:
      context: ./services/frontend
      dockerfile: Dockerfile
    container_name: proyecto_frontend
    ports:
      - "${FRONTEND_PORT}:80"
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
    restart: unless-stopped
    networks:
      - frontend_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================
  # üåê API Gateway (Nginx)
  # ==========================
  gateway:
    build:
      context: ./services/api-gateway
    container_name: proyecto_gateway
    ports:
      - "${GATEWAY_PORT}:80"
    depends_on:
      auth-service-1:
        condition: service_healthy
      auth-service-2:
        condition: service_healthy
      frontend:
        condition: service_healthy
      reservations-service-1:
        condition: service_healthy
      reservations-service-2:
        condition: service_healthy
      documents-service:
        condition: service_healthy
      datos-municipalidad-service:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
      chatbot-service:
        condition: service_healthy
    networks:
      - frontend_net
      - backend_net
    healthcheck:
      # Try wget first, fallback to curl if wget is not available
      test: ["CMD-SHELL", "wget -qO- http://localhost/health || curl -f http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
    restart: unless-stopped

  # ==========================
  # üóÉÔ∏è Backups autom√°ticos de PostgreSQL
  # ==========================
  # Instrucciones r√°pidas de prueba:
  # - Ejecutar un backup manual una sola vez:
  #   docker compose run --rm pg-backup /bin/sh -c "BACKUP_ONCE=1 /app/backup.sh && ls -l /backups"
  # - Verificar en MinIO:
  #   docker compose exec minio mc ls minio/${MINIO_BUCKET:-documents}  (si ya existe alias)
  # - Restaurar (ejemplo, auth_db):
  #   docker compose run --rm pg-backup /bin/sh -c \
  #     "/app/restore-db.sh auth-db auth_db admin ${AUTH_DB_PASSWORD}"
  pg-backup:
    build:
      context: ./infrastructure/pg-backup
      dockerfile: Dockerfile
    container_name: pg_backup
    env_file:
      - .env
    environment:
      # Cron en formato est√°ndar; por defecto 03:00 AM todos los d√≠as
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 3 * * *}
      # Configuraci√≥n MinIO (si no se desea subir, dejar MINIO_BUCKET vac√≠o)
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-db-backups}
      # Bases de datos y credenciales
      AUTH_DB_HOST: auth-db
      AUTH_DB_PORT: 5432
      AUTH_DB_NAME: ${AUTH_DB_NAME}
      AUTH_DB_USER: ${AUTH_DB_USER}
      AUTH_DB_PASSWORD: ${AUTH_DB_PASSWORD}
      RES_DB_HOST: reservations-db-primary
      RES_DB_PORT: 5432
      RES_DB_NAME: ${RESERVATIONS_DB_NAME}
      RES_DB_USER: ${RESERVATIONS_DB_USER}
      RES_DB_PASSWORD: ${RESERVATIONS_DB_PASSWORD}
      DOC_DB_HOST: documents-db
      DOC_DB_PORT: 5432
      DOC_DB_NAME: ${DOCUMENTS_DB_NAME}
      DOC_DB_USER: ${DOCUMENTS_DB_USER}
      DOC_DB_PASSWORD: ${DOCUMENTS_DB_PASSWORD}
      # Retenci√≥n (d√≠as)
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    volumes:
      # Volumen persistente para almacenar backups locales
      - pg_backups:/backups
      # Montar datos de primarias en solo lectura (requerido por consigna)
      - auth_primary_data:/pgdata/auth-ro:ro
      - reservations_primary_data:/pgdata/res-ro:ro
      - documents_data:/pgdata/doc-ro:ro
    depends_on:
      auth-db:
        condition: service_healthy
      reservations-db-primary:
        condition: service_healthy
      documents-db:
        condition: service_healthy
      minio:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
    networks:
      - database_net
      - storage_net
    restart: unless-stopped

# ==========================
# Monitoring services
# ==========================
  prometheus:
    image: prom/prometheus:v2.49.0
    container_name: prometheus
    volumes:
      - ./infrastructure/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./infrastructure/monitoring/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    networks:
      - backend_net
      - prometheus_net
      - monitoring_net
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:v0.25.0
    container_name: alertmanager
    volumes:
      - ./infrastructure/monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    ports:
      - "9093:9093"
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
    networks:
      - prometheus_net
      - backend_net
      - monitoring_net
    restart: unless-stopped

  grafana:
    image: grafana/grafana:9.5.8
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD}"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./infrastructure/monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./infrastructure/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
    networks:
      - backend_net
      - prometheus_net
      - monitoring_net
    restart: unless-stopped

  # cadvisor removed on Windows hosts (cgroup/mount incompatibilities). Run cadvisor on Linux/WSL2 if needed.

  node-exporter:
    image: prom/node-exporter:v1.6.1
    container_name: node_exporter
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "9100:9100"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 64M
    networks:
      - backend_net
      - prometheus_net
      - monitoring_net
    restart: unless-stopped

  redis-exporter:
    image: oliver006/redis_exporter:v1.43.1
    container_name: redis_exporter
    environment:
      - REDIS_ADDR=redis:6379
    ports:
      - "9121:9121"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 32M
    networks:
      - backend_net
      - prometheus_net
      - monitoring_net
    restart: unless-stopped

  postgres-exporter-auth:
    image: prometheuscommunity/postgres-exporter:v0.11.1
    container_name: postgres_exporter_auth
    environment:
      DATA_SOURCE_NAME: "postgresql://admin:admin@auth-db:5432/auth_db?sslmode=disable"
    ports:
      - "9187:9187"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 32M
    networks:
      - backend_net
      - prometheus_net
      - database_net
      - monitoring_net
    restart: unless-stopped

  postgres-exporter-reservations:
    image: prometheuscommunity/postgres-exporter:v0.11.1
    container_name: postgres_exporter_reservations
    environment:
      DATA_SOURCE_NAME: "postgresql://admin:admin@reservations-db-primary:5432/reservations_db?sslmode=disable"
      WEB_LISTEN_ADDRESS: ":9188"
    ports:
      - "9188:9187"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 32M
    networks:
      - backend_net
      - prometheus_net
      - database_net
      - monitoring_net
    restart: unless-stopped

  postgres-exporter-documents:
    image: prometheuscommunity/postgres-exporter:v0.11.1
    container_name: postgres_exporter_documents
    environment:
      DATA_SOURCE_NAME: "postgresql://admin:admin@documents-db:5432/documents_db?sslmode=disable"
      WEB_LISTEN_ADDRESS: ":9189"
    ports:
      - "9189:9187"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 32M
    networks:
      - backend_net
      - prometheus_net
      - database_net
      - monitoring_net
    restart: unless-stopped

  postgres-exporter-chatbot:
    image: prometheuscommunity/postgres-exporter:v0.11.1
    container_name: postgres_exporter_chatbot
    environment:
      DATA_SOURCE_NAME: "postgresql://admin:admin@chatbot-db:5432/chatbot_db?sslmode=disable"
      WEB_LISTEN_ADDRESS: ":9190"
    ports:
      - "9190:9187"
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 32M
    networks:
      - backend_net
      - prometheus_net
      - database_net
      - monitoring_net
    restart: unless-stopped

# ==========================
# Vol√∫menes persistentes
# ==========================
volumes:
  minio_data:
  redis_data:
  # Auth DB con r√©plica (HA)
  auth_primary_data:
  auth_replica_data:
  # Reservations DB con r√©plica (HA)
  reservations_primary_data:
  reservations_replica_data:
  # Documents DB sin r√©plica (optimizado)
  documents_data:
  # ChatBot DB sin r√©plica (optimizado)
  chatbot_data:
  # Ollama - Modelos de IA local (100% GRATUITO)
  ollama_models:
  # Backups
  pg_backups:
  # Monitoring
  prometheus_data:
  grafana_data:

# ==========================
# Redes
# ==========================
networks:
  frontend_net:
    driver: bridge
  backend_net:
    driver: bridge
  database_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  storage_net:
    driver: bridge

  # ==========================
  # üß≠ Monitoring stack
  # ==========================
  # Prometheus + Grafana + cAdvisor + exporters
  prometheus_net:
    driver: bridge
  monitoring_net:
    driver: bridge
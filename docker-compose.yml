x-security: &security
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  deploy:
    resources:
      limits:
        cpus: "0.5"
        memory: 512M
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

x-security-db: &security-db
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL
  cap_add:
    - CHOWN
    - SETGID
    - SETUID
    - DAC_OVERRIDE
  deploy:
    resources:
      limits:
        cpus: "0.5"
        memory: 512M
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

secrets:
  db_password:
    file: ./infrastructure/secrets/db_password.txt
  app_user_password:
    file: ./infrastructure/secrets/app_user_password.txt
  jwt_secret:
    file: ./infrastructure/secrets/jwt_secret.txt
  minio_access_key:
    file: ./infrastructure/secrets/minio_access_key.txt
  minio_secret_key:
    file: ./infrastructure/secrets/minio_secret_key.txt
  smtp_password:
    file: ./infrastructure/secrets/smtp_password.txt

services:
  # =============================================================================
  # DATABASES
  # =============================================================================
  
  auth-db:
    build: ./infrastructure/database/postgres-custom
    container_name: auth-db
    restart: unless-stopped
    <<: *security-db
    secrets:
      - db_password
      - app_user_password
    environment:
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: ${AUTH_DB_NAME}
    command: postgres -c 'config_file=/etc/postgresql/postgresql.conf' -c 'hba_file=/etc/postgresql/pg_hba.conf'
    volumes:
      - auth_db_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/auth-init:/docker-entrypoint-initdb.d
      - ./infrastructure/database/init/01-app-permissions.sh:/docker-entrypoint-initdb.d/01-app-permissions.sh
      - ./infrastructure/database/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./infrastructure/database/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
    networks:
      - backend-network

  reservations-db:
    build: ./infrastructure/database/postgres-custom
    container_name: reservations-db
    restart: unless-stopped
    <<: *security-db
    secrets:
      - db_password
      - app_user_password
    environment:
      POSTGRES_USER: ${RESERVATIONS_DB_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: ${RESERVATIONS_DB_NAME}
    command: postgres -c 'config_file=/etc/postgresql/postgresql.conf' -c 'hba_file=/etc/postgresql/pg_hba.conf'
    volumes:
      - reservations_db_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/reservations-init:/docker-entrypoint-initdb.d
      - ./infrastructure/database/init/01-app-permissions.sh:/docker-entrypoint-initdb.d/01-app-permissions.sh
      - ./infrastructure/database/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./infrastructure/database/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
    networks:
      - backend-network

  documents-db:
    build: ./infrastructure/database/postgres-custom
    container_name: documents-db
    restart: unless-stopped
    <<: *security-db
    secrets:
      - db_password
      - app_user_password
    environment:
      POSTGRES_USER: ${DOCUMENTS_DB_USER}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: ${DOCUMENTS_DB_NAME}
    command: postgres -c 'config_file=/etc/postgresql/postgresql.conf' -c 'hba_file=/etc/postgresql/pg_hba.conf'
    volumes:
      - documents_db_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/documents-init:/docker-entrypoint-initdb.d
      - ./infrastructure/database/init/01-app-permissions.sh:/docker-entrypoint-initdb.d/01-app-permissions.sh
      - ./infrastructure/database/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./infrastructure/database/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf
    networks:
      - backend-network

  redis:
    build: ./infrastructure/database/redis-custom
    container_name: redis
    restart: unless-stopped
    <<: *security-db
    volumes:
      - redis_data:/data
    networks:
      - backend-network

  minio:
    build: ./infrastructure/database/minio-custom
    container_name: minio
    restart: unless-stopped
    <<: *security-db
    command: server /data --console-address ":9001"
    secrets:
      - minio_access_key
      - minio_secret_key
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_access_key
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_secret_key
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9001"
    volumes:
      - minio_data:/data
    networks:
      - app-network

  # =============================================================================
  # BACKEND SERVICES
  # =============================================================================

  auth-service-1:
    build: ./services/auth-service
    container_name: auth-service-1
    restart: unless-stopped
    <<: *security
    secrets:
      - app_user_password
      - jwt_secret
    environment:
      DATABASE_URL_FILE: /run/secrets/app_user_password
      DB_HOST: auth-db
      DB_NAME: ${AUTH_DB_NAME}
      SECRET_KEY_FILE: /run/secrets/jwt_secret
      ALGORITHM: ${ALGORITHM}
      PORT: 8000
    depends_on:
      - auth-db
    networks:
      - app-network
      - backend-network

  auth-service-2:
    build: ./services/auth-service
    container_name: auth-service-2
    restart: unless-stopped
    <<: *security
    secrets:
      - app_user_password
      - jwt_secret
    environment:
      DATABASE_URL_FILE: /run/secrets/app_user_password
      DB_HOST: auth-db
      DB_NAME: ${AUTH_DB_NAME}
      SECRET_KEY_FILE: /run/secrets/jwt_secret
      ALGORITHM: ${ALGORITHM}
      PORT: 8000
    depends_on:
      - auth-db
    networks:
      - app-network
      - backend-network

  reservations-service-1:
    build: ./services/reservations-service
    container_name: reservations-service-1
    restart: unless-stopped
    <<: *security
    secrets:
      - app_user_password
    environment:
      DATABASE_URL_FILE: /run/secrets/app_user_password
      DB_HOST: reservations-db
      DB_NAME: ${RESERVATIONS_DB_NAME}
      AUTH_SERVICE_URL: http://auth_cluster:8000
      NOTIFICATIONS_SERVICE_URL: http://notifications-service:8004
      PORT: 8002
    depends_on:
      - reservations-db
    networks:
      - app-network
      - backend-network

  reservations-service-2:
    build: ./services/reservations-service
    container_name: reservations-service-2
    restart: unless-stopped
    <<: *security
    secrets:
      - app_user_password
    environment:
      DATABASE_URL_FILE: /run/secrets/app_user_password
      DB_HOST: reservations-db
      DB_NAME: ${RESERVATIONS_DB_NAME}
      AUTH_SERVICE_URL: http://auth_cluster:8000
      NOTIFICATIONS_SERVICE_URL: http://notifications-service:8004
      PORT: 8002
    depends_on:
      - reservations-db
    networks:
      - app-network
      - backend-network

  documents-service:
    build: ./services/documents-service
    container_name: documents-service
    restart: unless-stopped
    <<: *security
    secrets:
      - app_user_password
      - minio_access_key
      - minio_secret_key
    environment:
      DATABASE_URL_FILE: /run/secrets/app_user_password
      DB_HOST: documents-db
      DB_NAME: ${DOCUMENTS_DB_NAME}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY_FILE: /run/secrets/minio_access_key
      MINIO_SECRET_KEY_FILE: /run/secrets/minio_secret_key
      MINIO_BUCKET: documents
      AUTH_SERVICE_URL: http://auth_cluster:8000
      PORT: 8003
    depends_on:
      - documents-db
      - minio
    networks:
      - app-network
      - backend-network

  notifications-service:
    build: ./services/notificacion-service
    container_name: notifications-service
    restart: on-failure
    <<: *security
    secrets:
      - smtp_password
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD_FILE: /run/secrets/smtp_password
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL}
      PORT: 8004
    depends_on:
      - redis
    networks:
      - app-network
      - backend-network

  datos-municipalidad-service:
    build: ./services/datos-municipalidad-service
    container_name: datos-municipalidad-service
    restart: on-failure
    <<: *security
    secrets:
      - app_user_password
      - minio_access_key
      - minio_secret_key
    environment:
      DATABASE_URL_FILE: /run/secrets/app_user_password
      DB_HOST: documents-db
      DB_NAME: ${DOCUMENTS_DB_NAME}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY_FILE: /run/secrets/minio_access_key
      MINIO_SECRET_KEY_FILE: /run/secrets/minio_secret_key
      AUTH_SERVICE_URL: http://auth_cluster:8000
      PORT: 8006
    depends_on:
      - documents-db
      - minio
    networks:
      - app-network
      - backend-network

  # =============================================================================
  # FRONTEND & GATEWAY
  # =============================================================================

  frontend:
    build: ./services/frontend
    container_name: frontend
    restart: unless-stopped
    <<: *security
    ports:
      - "${FRONTEND_PORT}:3000"
      - "443:443"
    volumes:
      - ./infrastructure/certs:/etc/nginx/certs:ro
    networks:
      - app-network

  api-gateway:
    build: ./services/api-gateway
    container_name: api-gateway
    restart: unless-stopped
    <<: *security
    ports:
      - "${GATEWAY_PORT}:80"
      - "8443:443"
    volumes:
      - ./infrastructure/certs:/etc/nginx/certs:ro
    depends_on:
      - auth-service-1
      - auth-service-2
      - reservations-service-1
      - reservations-service-2
      - documents-service
      - notifications-service
      - datos-municipalidad-service
      - frontend
    networks:
      - app-network

volumes:
  auth_db_data:
  reservations_db_data:
  documents_db_data:
  redis_data:
  minio_data:

networks:
  app-network:
    driver: bridge
  backend-network:
    driver: bridge
    internal: true

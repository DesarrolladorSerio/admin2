
user  nginx;
worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    # Use Docker's embedded DNS resolver for runtime name resolution
    resolver 127.0.0.11 valid=30s;
    # Timeouts and proxy behavior sensible for upstreams to avoid 502s on transient failures
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
    proxy_next_upstream_tries 3;

    # Security headers applied to all responses from the gateway
    # Note: use 'always' so error responses also include the headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' data:;" always;
    
    # CORS Headers - Manejado centralmente por Nginx API Gateway
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # Upstream: auth_cluster (round-robin by default)
    # - auth-service-1 and auth-service-2 are application instances that serve auth API
    # - Nginx will perform simple round-robin load balancing across these backends
    upstream auth_cluster {
        server auth-service-1:8000;
        server auth-service-2:8000;
    }

    # Upstream: reservations_cluster (round-robin)
    upstream reservations_cluster {
        server reservations-service-1:8002;
        server reservations-service-2:8002;
    }
    
    # Upstream: documents_cluster (single instance)
    upstream documents_cluster {
        server documents-service:8003;
    }
    
    # Upstream: notifications_cluster (single instance)
    upstream notifications_cluster {
        server notifications-service:8004;
    }
    
    # Upstream: chatbot_cluster (instancia √∫nica - optimizado)
    upstream chatbot_cluster {
        server chatbot-service:8005;
    }
    
    # Frontend will be resolved at request time using the resolver

    server {
        listen 80;
        server_name proyecto-redes.local;

        # Common proxy headers for all proxied locations
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Error page handling: show a generic 50x page if backend fails
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            # Serve a static, friendly error page
            root /usr/share/nginx/html;
            internal;
        }

        # Simple JSON status endpoint (useful for monitoring)
        # Returns 200 with a small JSON payload indicating gateway health
        location = /status {
            access_log off;
            add_header Content-Type application/json;
            return 200 '{"status":"ok","service":"api-gateway"}';
        }

        # Health endpoint for Docker (keeps it lightweight)
        location = /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 'OK';
        }

        # üîπ SERVICIO DE AUTENTICACI√ìN - AUTH SERVICE
        # =============================================================================
        
        # üîê Login y obtenci√≥n de tokens
        location /api/auth/token {
            proxy_pass http://auth_cluster/token;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîê Registro de usuarios normales
        location /api/auth/register {
            proxy_pass http://auth_cluster/register;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üë§ Informaci√≥n del usuario actual
        location /api/auth/users/me {
            proxy_pass http://auth_cluster/users/me;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üë• Lista de usuarios (admin/empleados)
        location /api/auth/users {
            proxy_pass http://auth_cluster/users;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üë§ Usuario espec√≠fico por ID
        location /api/auth/users/ {
            proxy_pass http://auth_cluster/users/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚úÖ Verificaci√≥n de usuario (para otros servicios)
        location /api/auth/verify-user/ {
            proxy_pass http://auth_cluster/verify-user/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîë Solicitar recuperaci√≥n de contrase√±a
        location /api/auth/password-reset/request {
            proxy_pass http://auth_cluster/password-reset/request;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ÔøΩ Confirmar nueva contrase√±a
        location /api/auth/password-reset/confirm {
            proxy_pass http://auth_cluster/password-reset/confirm;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üë®‚Äçüíº Registro de empleados (solo admins)
        location /api/auth/admin/employees {
            proxy_pass http://auth_cluster/admin/employees;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìã RF12: Consultar licencias por vencer
        location /api/auth/admin/licencias-por-vencer {
            proxy_pass http://auth_cluster/admin/licencias-por-vencer;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üèõÔ∏è RF02: Consultar datos municipales del ciudadano
        location /api/auth/consultar-datos-municipales {
            proxy_pass http://auth_cluster/consultar-datos-municipales;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ù§Ô∏è Health check del servicio de auth
        location /api/auth/health {
            proxy_pass http://auth_cluster/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # üîπ Fallback para cualquier otra ruta de auth
        location /api/auth/ {
            proxy_pass http://auth_cluster/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîπ SERVICIO DE RESERVACIONES - RESERVATIONS SERVICE
        # =============================================================================
        
        # üìÖ Crear nueva reservaci√≥n
        location /api/reservations/reservations {
            proxy_pass http://reservations_cluster/reservations;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìã Obtener reservaciones del usuario
        location = /api/reservations/reservations {
            proxy_pass http://reservations_cluster/reservations;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìÑ Reservaci√≥n espec√≠fica por ID
        location /api/reservations/reservations/ {
            proxy_pass http://reservations_cluster/reservations/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üë®‚Äçüíº Todas las reservaciones (vista admin)
        location /api/reservations/admin/reservations {
            proxy_pass http://reservations_cluster/admin/reservations;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìä Dashboard administrativo (RF08)
        location /api/reservations/admin/dashboard {
            proxy_pass http://reservations_cluster/admin/dashboard;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîç B√∫squeda avanzada de reservas (RF09)
        location /api/reservations/admin/buscar-reservas {
            proxy_pass http://reservations_cluster/admin/buscar-reservas;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìà Estad√≠sticas y rankings por tr√°mite (RF09)
        location /api/reservations/admin/estadisticas-tramites {
            proxy_pass http://reservations_cluster/admin/estadisticas-tramites;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìß Enviar notificaciones a ciudadanos (RF10)
        location ~ /api/reservations/admin/enviar-notificacion/(.*)$ {
            proxy_pass http://reservations_cluster/admin/enviar-notificacion/$1$is_args$args;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚è∞ Consultar vencimientos pr√≥ximos (RF12)
        location /api/reservations/admin/vencimientos-proximos {
            proxy_pass http://reservations_cluster/admin/vencimientos-proximos;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ùå Anular reserva (RF13)
        location ~ /api/reservations/admin/anular-reserva/(.*)$ {
            proxy_pass http://reservations_cluster/admin/anular-reserva/$1$is_args$args;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìã Actualizar estado documental (RF08)
        location ~ /api/reservations/admin/actualizar-estado-documental/(.*)$ {
            proxy_pass http://reservations_cluster/admin/actualizar-estado-documental/$1$is_args$args;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìÖ Reservaciones por rango de fechas para calendario
        location /api/reservations/reservations/calendar/ {
            proxy_pass http://reservations_cluster/reservations/calendar/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìù Tipos de tr√°mites disponibles
        location /api/reservations/tipos-tramites {
            proxy_pass http://reservations_cluster/tipos-tramites;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚úÖ Verificar disponibilidad de horario
        location /api/reservations/check-availability/ {
            proxy_pass http://reservations_cluster/check-availability/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîç RF05: Validar requisitos para tipo de tr√°mite
        location /api/reservations/validar-requisitos-tramite {
            proxy_pass http://reservations_cluster/validar-requisitos-tramite;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ù§Ô∏è Health check del servicio de reservaciones
        location /api/reservations/health {
            proxy_pass http://reservations_cluster/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # üîπ Fallback para cualquier otra ruta de reservaciones
        location /api/reservations/ {
            proxy_pass http://reservations_cluster/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîπ SERVICIO DE DOCUMENTOS - DOCUMENTS SERVICE  
        # =============================================================================
        
        # ÔøΩ Subir documento ciudadano (RF14-RF15)
        location /api/documents/upload-documento {
            proxy_pass http://documents_cluster/upload-documento;
            proxy_connect_timeout 15s;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            client_max_body_size 50M;
            proxy_request_buffering off;
            proxy_buffering off;
        }

        # üìë Documentos de una reserva
        location ~ /api/documents/documentos/reserva/(.*)$ {
            proxy_pass http://documents_cluster/documentos/reserva/$1$is_args$args;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìã Documentos de un usuario
        location ~ /api/documents/documentos/usuario/(.*)$ {
            proxy_pass http://documents_cluster/documentos/usuario/$1$is_args$args;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚úÖ Revisar documento (admin/employee)
        location ~ /api/documents/documentos/(.*)/revisar$ {
            proxy_pass http://documents_cluster/documentos/$1/revisar$is_args$args;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìú Subir documento antiguo (RF15)
        location /api/documents/documentos-antiguos {
            proxy_pass http://documents_cluster/documentos-antiguos;
            proxy_connect_timeout 15s;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            client_max_body_size 50M;
            proxy_request_buffering off;
            proxy_buffering off;
        }

        # üìö Documentos antiguos pendientes
        location /api/documents/documentos-antiguos/pendientes {
            proxy_pass http://documents_cluster/documentos-antiguos/pendientes;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîç Buscar documentos antiguos (RF16)
        location /api/documents/documentos-antiguos/buscar {
            proxy_pass http://documents_cluster/documentos-antiguos/buscar;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚úÖ Completar digitalizaci√≥n documento antiguo
        location ~ /api/documents/documentos-antiguos/(.*)/completar$ {
            proxy_pass http://documents_cluster/documentos-antiguos/$1/completar$is_args$args;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìä Registro de digitalizaci√≥n (RF14, RF18)
        location /api/documents/registro-digitalizacion {
            proxy_pass http://documents_cluster/registro-digitalizacion;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìà Reportes de digitalizaci√≥n (RF18)
        location /api/documents/reportes/digitalizacion/diario {
            proxy_pass http://documents_cluster/reportes/digitalizacion/diario;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        location /api/documents/reportes/digitalizacion/semanal {
            proxy_pass http://documents_cluster/reportes/digitalizacion/semanal;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        location /api/documents/reportes/digitalizacion/mensual {
            proxy_pass http://documents_cluster/reportes/digitalizacion/mensual;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        location /api/documents/reportes/avance-antiguos {
            proxy_pass http://documents_cluster/reportes/avance-antiguos;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }
        
        # ÔøΩüìÅ Tipos de documentos disponibles
        location /api/documents/document-types {
            proxy_pass http://documents_cluster/document-types;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ÔøΩ Subir documento (archivo grande)
        location /api/documents/upload {
            proxy_pass http://documents_cluster/upload;
            proxy_connect_timeout 15s;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            client_max_body_size 50M;
            # Configuraciones especiales para upload
            proxy_request_buffering off;
            proxy_buffering off;
        }

        # üìÑ Mis documentos
        location /api/documents/my-documents {
            proxy_pass http://documents_cluster/my-documents;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìÑ Informaci√≥n espec√≠fica de un documento
        location /api/documents/document/ {
            proxy_pass http://documents_cluster/document/;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üì• Descargar documento
        location /api/documents/download/ {
            proxy_pass http://documents_cluster/download/;
            proxy_connect_timeout 15s;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            client_max_body_size 50M;
        }

        # üëÅÔ∏è Vista previa de documento
        location /api/documents/preview/ {
            proxy_pass http://documents_cluster/preview/;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìä Estad√≠sticas del usuario
        location /api/documents/stats {
            proxy_pass http://documents_cluster/stats;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîç Buscar documentos
        location /api/documents/search {
            proxy_pass http://documents_cluster/search;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ü§ù Documentos compartidos conmigo
        location /api/documents/shared-with-me {
            proxy_pass http://documents_cluster/shared-with-me;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üß™ Test del servicio
        location /api/documents/test {
            proxy_pass http://documents_cluster/test;
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ù§Ô∏è Health check del servicio de documentos
        location /api/documents/health {
            proxy_pass http://documents_cluster/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # üîπ Fallback para cualquier otra ruta de documentos
        location /api/documents/ {
            proxy_pass http://documents_cluster/;
            proxy_connect_timeout 15s;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            client_max_body_size 50M;
        }

        # üîπ SERVICIO DE NOTIFICACIONES - NOTIFICATIONS SERVICE
        # =============================================================================
        
        # üìß Enviar email gen√©rico
        location /api/notifications/email {
            proxy_pass http://notifications_cluster/api/notifications/email;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìÖ Confirmaci√≥n de reserva
        location /api/notifications/reservation/confirmation {
            proxy_pass http://notifications_cluster/api/notifications/reservation/confirmation;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚è∞ Recordatorio de reserva
        location /api/notifications/reservation/reminder {
            proxy_pass http://notifications_cluster/api/notifications/reservation/reminder;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ùå Cancelaci√≥n de reserva
        location /api/notifications/reservation/cancellation {
            proxy_pass http://notifications_cluster/api/notifications/reservation/cancellation;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìÑ Notificaci√≥n de documento
        location /api/notifications/document {
            proxy_pass http://notifications_cluster/api/notifications/document;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üëã Email de bienvenida
        location /api/notifications/welcome {
            proxy_pass http://notifications_cluster/api/notifications/welcome;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîë Recuperaci√≥n de contrase√±a
        location /api/notifications/password-reset {
            proxy_pass http://notifications_cluster/api/notifications/password-reset;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üì¨ Env√≠o masivo de emails
        location /api/notifications/batch {
            proxy_pass http://notifications_cluster/api/notifications/batch;
            proxy_connect_timeout 10s;
            proxy_read_timeout 120s;
            proxy_send_timeout 120s;
        }

        # üîç Estado de tarea espec√≠fica
        location /api/notifications/task/ {
            proxy_pass http://notifications_cluster/api/notifications/task/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìä Estad√≠sticas del servicio de notificaciones
        location /api/notifications/stats {
            proxy_pass http://notifications_cluster/api/notifications/stats;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ù§Ô∏è Health check del servicio de notificaciones
        location /api/notifications/health {
            proxy_pass http://notifications_cluster/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # üè† P√°gina principal del servicio
        location = /api/notifications/ {
            proxy_pass http://notifications_cluster/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîπ Fallback para cualquier otra ruta de notificaciones
        location /api/notifications/ {
            proxy_pass http://notifications_cluster/api/notifications/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîπ SERVICIO DE CHATBOT IA - AI SERVICE
        # =============================================================================
        
        # ü§ñ Chatbot p√∫blico (sin autenticaci√≥n)
        location /api/chatbot/chat/public {
            proxy_pass http://chatbot_cluster/chat/public;
            proxy_connect_timeout 10s;
            proxy_read_timeout 120s;  # Mayor timeout para IA
            proxy_send_timeout 120s;
        }
        
        # ü§ñ Enviar mensaje al chatbot (autenticado)
        location /api/chatbot/chat {
            proxy_pass http://chatbot_cluster/chat;
            proxy_connect_timeout 10s;
            proxy_read_timeout 120s;  # Mayor timeout para IA
            proxy_send_timeout 120s;
        }

        # üìö Historial de sesi√≥n espec√≠fica
        location /api/chatbot/chat/history/ {
            proxy_pass http://chatbot_cluster/chat/history/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üóëÔ∏è Eliminar sesi√≥n de chat
        location /api/chatbot/chat/session/ {
            proxy_pass http://chatbot_cluster/chat/session/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìä M√©tricas del chatbot
        location /api/chatbot/chat/metrics {
            proxy_pass http://chatbot_cluster/chat/metrics;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ÔøΩ Todas las conversaciones del usuario (con preview)
        location /api/chatbot/chat/conversations {
            proxy_pass http://chatbot_cluster/chat/conversations;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ÔøΩüí¨ Todas las sesiones del usuario (deprecado, usar conversations)
        location /api/chatbot/chat/sessions {
            proxy_pass http://chatbot_cluster/chat/sessions;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìã Obtener historial de sesi√≥n
        location /api/chatbot/sessions {
            proxy_pass http://chatbot_cluster/sessions;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # ‚ù§Ô∏è Health check del servicio de chatbot
        location /api/chatbot/health {
            proxy_pass http://chatbot_cluster/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # üè† P√°gina principal del chatbot
        location = /api/chatbot/ {
            proxy_pass http://chatbot_cluster/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üîπ Fallback para cualquier otra ruta del chatbot
        location /api/chatbot/ {
            proxy_pass http://chatbot_cluster/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 120s;  # Mayor timeout para IA
            proxy_send_timeout 120s;
        }

        # üîπ RUTAS DE MONITOREO Y GESTI√ìN
        # =============================================================================
        
        # üìä Prometheus metrics (para monitoreo)
        location /metrics {
            proxy_pass http://prometheus:9090/metrics;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
            access_log off;
        }

        # üìà Grafana (dashboard de monitoreo)
        location /grafana/ {
            proxy_pass http://grafana:3000/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # üö® AlertManager (gesti√≥n de alertas)
        location /alertmanager/ {
            proxy_pass http://alertmanager:9093/;
            proxy_connect_timeout 10s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # üìä Estado global de todos los servicios
        location /api/status {
            access_log off;
            add_header Content-Type application/json;
            return 200 '{
                "status": "ok",
                "services": {
                    "auth": "http://auth_cluster",
                    "reservations": "http://reservations_cluster", 
                    "documents": "http://documents_cluster",
                    "notifications": "http://notifications_cluster",
                    "chatbot": "http://chatbot_cluster",
                    "frontend": "http://frontend:80"
                },
                "gateway": "nginx",
                "timestamp": "$time_iso8601"
            }';
        }

        # üîÑ Reload de configuraci√≥n (para desarrollo)
        location /api/reload {
            access_log off;
            add_header Content-Type application/json;
            return 200 '{"message": "Use docker-compose restart gateway to reload config"}';
        }

        # üîπ Rutas frontend (resolve at request time to avoid startup DNS failures)
        # Frontend proxy (single instance). Resolve at request time via Docker DNS.
        location / {
            proxy_pass http://frontend:80/;
            proxy_connect_timeout 5s;
            proxy_read_timeout 30s;
            proxy_send_timeout 30s;
        }

        # üîπ Healthcheck del gateway
        location /health {
            access_log off;
            return 200 "Gateway OK";
            add_header Content-Type text/plain;
        }
    }
}
